<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatchSensor | MQTT Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-[#f9fafb] text-slate-900 min-h-screen flex flex-col items-center p-6 sm:p-12">
    <div class="max-w-2xl w-full space-y-8">
        <header class="flex items-center space-x-4 mb-8">
            <div class="bg-[#1b3a2e] p-3 rounded-2xl shadow-lg text-white">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M4.9 19.1C3.1 17.4 2 15 2 12s1.1-5.4 2.9-7.1M19.1 4.9C20.9 6.6 22 9 22 12s-1.1 5.4-2.9 7.1M7.7 16.3C6.6 15.3 6 13.7 6 12s.6-3.3 1.7-4.3M16.3 7.7C17.4 8.7 18 10.3 18 12s-.6 3.3-1.7 4.3M12 11a1 1 0 1 0 0 2 1 1 0 0 0 0-2z" />
                </svg>
            </div>
            <div>
                <h1 class="text-3xl font-black text-[#1b3a2e] leading-none">MQTT Simulator</h1>
                <p class="text-slate-400 font-bold text-[10px] uppercase tracking-widest mt-1">Standalone Test-Tool</p>
            </div>
        </header>

        <main class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100 space-y-8">
            <div class="space-y-4">
                <label class="block text-[10px] font-black tracking-widest text-slate-400 uppercase">Zugangsdaten
                    (Token)</label>
                <input id="token" type="password" placeholder="JWT Token aus dem Browser"
                    class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold text-sm focus:ring-2 focus:ring-[#1b3a2e] outline-none">
            </div>

            <div class="space-y-4">
                <label class="block text-[10px] font-black tracking-widest text-slate-400 uppercase">Ger채te IMEI</label>
                <input id="imei" type="text" placeholder="z.B. 862000000000004"
                    class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 font-bold text-sm focus:ring-2 focus:ring-[#1b3a2e] outline-none">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="setStatus('active')" id="btn-active"
                    class="p-6 rounded-3xl bg-green-50 text-green-700 border-2 border-green-500 font-black flex flex-col items-center gap-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    <span class="text-xs uppercase tracking-widest">Aktiv</span>
                </button>
                <button onclick="setStatus('triggered')" id="btn-triggered"
                    class="p-6 rounded-3xl bg-slate-50 text-slate-400 border-2 border-transparent font-black flex flex-col items-center gap-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                        <line x1="12" y1="9" x2="12" y2="13" />
                        <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                    <span class="text-xs uppercase tracking-widest">Alarm</span>
                </button>
            </div>

            <div class="space-y-6">
                <div class="flex justify-between items-center bg-slate-50 p-6 rounded-3xl">
                    <div class="space-y-1">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Batterie-Spannung</p>
                        <p id="label-v" class="text-xl font-black text-slate-900">4200 mV</p>
                    </div>
                    <input type="range" id="voltage" min="3200" max="4200" value="4200" oninput="updateUI()"
                        class="h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-[#1b3a2e]">
                </div>

                <div class="flex justify-between items-center bg-slate-50 p-6 rounded-3xl">
                    <div class="space-y-1">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Signalst채rke (RSSI)
                        </p>
                        <p id="label-r" class="text-xl font-black text-slate-900">-60 dBm</p>
                    </div>
                    <input type="range" id="rssi" min="30" max="120" value="60" oninput="updateUI()"
                        class="h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-[#1b3a2e]">
                </div>
            </div>

            <button onclick="sendSim()" id="btn-send"
                class="w-full bg-[#1b3a2e] text-white py-6 rounded-[2rem] font-black uppercase tracking-[0.3em] text-xs shadow-2xl shadow-green-900/40 transform active:scale-95 transition-all">
                Simulation Senden
            </button>

            <div id="status-msg" class="hidden p-4 rounded-2xl text-center text-xs font-bold"></div>
        </main>

        <p class="text-[10px] text-slate-400 text-center font-black uppercase tracking-widest opacity-40 px-12">
            Hinweis: Dieses Tool ist ein eigenst채ndiges Modul zur Systemvalidierung. Es sendet echte Bin채rpakete an den
            MQTT-Broker.
        </p>
    </div>

    <script>
        let selectedStatus = 'active';

        function setStatus(s) {
            selectedStatus = s;
            document.getElementById('btn-active').classList = s === 'active' ? 'p-6 rounded-3xl bg-green-50 text-green-700 border-2 border-green-500 font-black flex flex-col items-center gap-2' : 'p-6 rounded-3xl bg-slate-50 text-slate-400 border-2 border-transparent font-black flex flex-col items-center gap-2';
            document.getElementById('btn-triggered').classList = s === 'triggered' ? 'p-6 rounded-3xl bg-red-50 text-red-700 border-2 border-red-500 font-black flex flex-col items-center gap-2' : 'p-6 rounded-3xl bg-slate-50 text-slate-400 border-2 border-transparent font-black flex flex-col items-center gap-2';
        }

        function updateUI() {
            document.getElementById('label-v').innerText = document.getElementById('voltage').value + ' mV';
            document.getElementById('label-r').innerText = '-' + document.getElementById('rssi').value + ' dBm';
        }

        async function sendSim() {
            const btn = document.getElementById('btn-send');
            const msg = document.getElementById('status-msg');
            const token = document.getElementById('token').value;
            const imei = document.getElementById('imei').value;

            if (!imei) { alert('Bitte IMEI eingeben'); return; }

            btn.disabled = true;
            btn.innerText = 'SENDET...';
            msg.className = 'hidden';

            try {
                const res = await fetch('/api/Catchs/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        imei: imei,
                        status: selectedStatus,
                        batteryVoltage: parseInt(document.getElementById('voltage').value),
                        rssi: parseInt(document.getElementById('rssi').value)
                    })
                });

                const data = await res.json();
                msg.classList.remove('hidden');
                if (res.ok) {
                    msg.className = 'p-4 rounded-2xl text-center text-xs font-bold bg-green-100 text-green-700';
                    msg.innerText = 'Erfolg: ' + data.message;
                } else {
                    msg.className = 'p-4 rounded-2xl text-center text-xs font-bold bg-red-100 text-red-700';
                    msg.innerText = 'Fehler: ' + (data.error || 'Unbekannt');
                }
            } catch (e) {
                msg.classList.remove('hidden');
                msg.className = 'p-4 rounded-2xl text-center text-xs font-bold bg-red-100 text-red-700';
                msg.innerText = 'Netzwerkfehler';
            }

            btn.disabled = false;
            btn.innerText = 'Simulation Senden';
        }

        // Try to pre-fill token if available (works if opened from same origin)
        if (localStorage.getItem('token')) {
            document.getElementById('token').value = localStorage.getItem('token');
        }
    </script>
</body>

</html>
